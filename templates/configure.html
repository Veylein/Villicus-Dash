{% extends 'layout.html' %}
{% block title %}Configure — Villicus{% endblock %}
{% block content %}
  <div class="space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold">Configure Guild</h2>
        <p class="text-sm text-slate-400">Guild ID: {{ guild_id }}</p>
      </div>
      <div class="text-sm text-slate-300">Changes save live — staff roles update instantly.</div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 space-y-4">
        <div class="p-6 rounded-xl bg-slate-900/50 shadow-md">
          <h3 class="font-semibold">Warns → Auto Punish</h3>
          <p class="text-sm text-slate-400 mt-1">Configure how many warns before the automated punishment triggers.</p>
          <form id="main-settings" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <label class="flex flex-col">
              <span class="text-sm text-slate-300">Warns until punish</span>
              <input type="number" name="warns_to_punish" id="warns_to_punish" min="0" class="mt-1 px-3 py-2 rounded-md bg-slate-800 border border-slate-700" value="{{ settings.get('warns_to_punish') or '' }}" />
            </label>

            <label class="flex flex-col">
              <span class="text-sm text-slate-300">Warn action</span>
              <select name="warn_action" id="warn_action" class="mt-1 px-3 py-2 rounded-md bg-slate-800 border border-slate-700">
                <option value="mute" {% if settings.get('warn_punish_action') == 'mute' %}selected{% endif %}>Mute</option>
                <option value="tempban" {% if settings.get('warn_punish_action') == 'tempban' %}selected{% endif %}>Tempban</option>
                <option value="kick" {% if settings.get('warn_punish_action') == 'kick' %}selected{% endif %}>Kick</option>
                <option value="ban" {% if settings.get('warn_punish_action') == 'ban' %}selected{% endif %}>Ban</option>
              </select>
            </label>

            <label class="flex flex-col">
              <span class="text-sm text-slate-300">Theme</span>
              <select name="theme" id="theme-select" class="mt-1 px-3 py-2 rounded-md bg-slate-800 border border-slate-700">
                <option value="dark" {% if settings.get('theme') == 'dark' %}selected{% endif %}>Dark</option>
                <option value="light" {% if settings.get('theme') == 'light' %}selected{% endif %}>Light</option>
              </select>
            </label>

            <label class="flex flex-col">
              <span class="text-sm text-slate-300">Accent color</span>
              <input type="color" name="accent_color" id="accent-color" class="w-24 h-10 mt-1 rounded-md" value="{{ settings.get('accent_color') or '#6ee7b7' }}" />
            </label>

            <div class="sm:col-span-2 flex gap-3 items-center">
              <button id="save-main" class="px-4 py-2 rounded-md bg-emerald-400 text-slate-900 font-semibold">Save settings</button>
              <span id="save-status" class="text-sm text-slate-400"></span>
            </div>
          </form>
        </div>

        <div class="p-6 rounded-xl bg-slate-900/50 shadow-md">
          <h3 class="font-semibold">Staff Roles & Levels</h3>
          <p class="text-sm text-slate-400 mt-1">Grant staff roles and assign levels (1 = lowest, 10 = highest).</p>

          <div id="staff-card" class="mt-4 space-y-3">
            {% for entry in settings.get('staff_roles_list', []) %}
              <div class="flex items-center justify-between p-3 rounded-md bg-slate-800 border border-slate-700" data-role-id="{{ entry.id }}">
                <div>
                  <div class="font-medium">{{ entry.name }}</div>
                  <div class="text-sm text-slate-400">ID: {{ entry.id }}</div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-sm text-slate-300">Level</div>
                  <input type="number" min="1" max="10" value="{{ entry.level }}" class="w-16 px-2 py-1 rounded-md bg-slate-900 border border-slate-700 role-level" />
                  <button class="remove-role px-3 py-1 rounded-md bg-rose-600 text-white">Remove</button>
                </div>
              </div>
            {% else %}
              <div class="text-sm text-slate-400">No staff roles configured yet.</div>
            {% endfor %}
          </div>

          <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
            <input type="text" id="new-role-id" placeholder="Role ID" class="px-3 py-2 rounded-md bg-slate-800 border border-slate-700" />
            <input type="number" id="new-role-level" placeholder="Level 1-10" min="1" max="10" class="px-3 py-2 rounded-md bg-slate-800 border border-slate-700" />
            <button id="add-role" class="px-3 py-2 rounded-md bg-emerald-500 text-slate-900 font-semibold">Add Role</button>
          </div>
        </div>
      </section>

      <aside class="space-y-4">
        <div class="p-4 rounded-xl bg-slate-900/40 shadow-sm">
          <h4 class="font-semibold">Preview</h4>
          <div class="mt-3 p-3 rounded-md bg-gradient-to-b from-slate-800/40 to-slate-800/20 border border-slate-700">
            <div class="text-sm text-slate-300">Accent preview</div>
            <div id="accent-preview" class="mt-3 h-12 rounded-md" style="background: var(--accent);"></div>
          </div>
        </div>

        <div class="p-4 rounded-xl bg-slate-900/40 shadow-sm">
          <h4 class="font-semibold">Quick Links</h4>
          <ul class="mt-2 text-sm text-slate-300 space-y-1">
            <li><a href="/" class="text-emerald-300">Home</a></li>
            <li><a href="/dashboard" class="text-emerald-300">Back to Dashboard</a></li>
          </ul>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Helpers
    const saveStatus = document.getElementById('save-status');
    function showStatus(msg, ok=true){ saveStatus.textContent = msg; saveStatus.style.color = ok ? '#9ae6b4' : '#fda4af'; setTimeout(()=>{ saveStatus.textContent = '' }, 2500); }

    // Live theme & accent
    const accentInput = document.getElementById('accent-color') || document.getElementById('accent-color');
    const accentPreview = document.getElementById('accent-preview');
    const themeSelect = document.getElementById('theme-select');
    const accentColor = document.getElementById('accent-color');

    function setAccent(val){ document.documentElement.style.setProperty('--accent', val); if(accentPreview) accentPreview.style.background = val; }
    // initialize from server value
    const initialAccent = '{{ settings.get("accent_color") or "#6ee7b7" }}';
    setAccent(initialAccent);

    // Save main settings via AJAX
    document.getElementById('save-main').addEventListener('click', async (e)=>{
      e.preventDefault();
      const warns = document.getElementById('warns_to_punish').value;
      const action = document.getElementById('warn_action').value;
      const theme = document.getElementById('theme-select').value;
      const accent = document.getElementById('accent-color').value;
      const payload = { warns_to_punish: warns ? String(warns) : null, warn_punish_action: action, theme: theme, accent_color: accent };
      try{
        const r = await fetch(window.location.pathname + '/save_setting', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(r.ok) { setAccent(accent); showStatus('Saved', true); } else { showStatus('Save failed', false); }
      } catch(err){ showStatus('Network error', false); }
    });

    // Add role
    document.getElementById('add-role').addEventListener('click', async ()=>{
      const roleId = document.getElementById('new-role-id').value.trim();
      const level = document.getElementById('new-role-level').value.trim();
      if(!roleId || !level) return showStatus('Provide role id and level', false);
      try{
        const r = await fetch(window.location.pathname + '/add_staff', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ role_id: roleId, level: Number(level) }) });
        if(r.ok) window.location.reload(); else showStatus('Add failed', false);
      }catch(e){ showStatus('Network error', false); }
    });

    // Remove role
    document.querySelectorAll('.remove-role').forEach(btn=> btn.addEventListener('click', async (e)=>{
      const li = e.target.closest('[data-role-id]');
      const roleId = li.getAttribute('data-role-id');
      try{
        const r = await fetch(window.location.pathname + '/remove_staff', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ role_id: Number(roleId) }) });
        if(r.ok) window.location.reload(); else showStatus('Remove failed', false);
      }catch(e){ showStatus('Network error', false); }
    }));

    // Update role level inline
    document.querySelectorAll('.role-level').forEach(inp=> inp.addEventListener('change', async (e)=>{
      const container = e.target.closest('[data-role-id]');
      const roleId = container.getAttribute('data-role-id');
      const level = Number(e.target.value);
      if(level < 1 || level > 10) return showStatus('Level must be 1-10', false);
      try{
        const r = await fetch(window.location.pathname + '/add_staff', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ role_id: Number(roleId), level }) });
        if(r.ok) showStatus('Updated', true); else showStatus('Update failed', false);
      }catch(e){ showStatus('Network error', false); }
    }));
  </script>

{% endblock %}
